# Lambda Functions

This directory contains AWS Lambda functions and layers for the BecomeLog application.

## Structure

```
lambda/
├── functions/           # Lambda function handlers
│   ├── api-handler/    # Main API Gateway handler
│   └── auth-handler/   # Authentication/authorization handler
├── layers/             # Lambda layers for shared dependencies
│   └── package.json    # Layer dependencies
└── shared/             # Shared utilities used by functions
    └── index.js        # Common utilities (response helpers, validation, etc.)
```

## Building Lambda Functions

Lambda functions must be packaged as ZIP files before deploying with Terraform.

### Build Script

Run the build script from the repository root:

```bash
./scripts/build-lambda.sh
```

This script will:
1. Create a Lambda layer with dependencies from `layers/package.json`
2. Package each Lambda function with the shared utilities
3. Generate the required ZIP files:
   - `lambda/layers/dependencies.zip`
   - `lambda/functions/api-handler.zip`
   - `lambda/functions/auth-handler.zip`

### GitHub Actions

The build process is integrated into the CI/CD workflow (`.github/workflows/deploy-become.yml`) and runs automatically before Terraform deployment.

## Lambda Functions

### API Handler (`api-handler`)

Main API Gateway handler for the BecomeLog application.

**Endpoints:**
- `GET /health` - Health check
- `GET /api/entries` - Get journal entries
- `POST /api/entries` - Create a new entry

### Auth Handler (`auth-handler`)

Custom authorizer for API Gateway that validates authentication tokens.

## Shared Utilities

The `shared/` directory contains common utilities used by all Lambda functions:

- `createResponse(statusCode, body, headers)` - Create standard API response
- `successResponse(data, statusCode)` - Create success response
- `errorResponse(message, statusCode, details)` - Create error response
- `validateRequiredFields(obj, requiredFields)` - Validate required fields
- `parseEventBody(event)` - Parse event body safely

## Development

### Local Development

To test Lambda functions locally, you can use the AWS SAM CLI or invoke them directly:

```bash
# Example: Test API handler (async handler returns a Promise)
node -e "const handler = require('./lambda/functions/api-handler/index.js'); \
  handler.handler({httpMethod: 'GET', path: '/health'}).then(console.log)"
```

Note: All Lambda functions in this project use async handlers that return Promises.

### Adding a New Function

1. Create a new directory under `functions/`
2. Add an `index.js` with an exported `handler` function
3. Update the build script if needed
4. Add Terraform resources in `terraform/resources.tf`

### Adding Dependencies

If you need to add npm dependencies:

1. Add them to `lambda/layers/package.json`
2. Run the build script to update the layer
3. The layer will be automatically attached to all functions

## Notes

- ZIP files are automatically generated by the build script and are not committed to git
- The Lambda layer currently has no dependencies, but the structure is ready for adding them
- All functions use Node.js 20.x runtime
- Shared utilities are included in each function's ZIP file for standalone execution
